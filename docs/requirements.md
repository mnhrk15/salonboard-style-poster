## **SALON BOARDスタイル自動投稿Webアプリケーション 要件定義書**

### **1. 概要**

### **1.1. はじめに**

本ドキュメントは、「SALON BOARDスタイル自動投稿Webアプリケーション」（以下、本アプリ）の開発にあたり、その仕様、機能、および非機能要件を定義するものである。本アプリは、**管理者によって承認されたユーザーのみが利用できるクローズドなシステム**として設計される。

### **1.2. 開発背景と目的**

美容室スタッフが手作業で行っているSALON BOARDへのスタイル投稿作業は、依然として大きな業務負担となっている。本アプリは、このプロセスを自動化することで、スタッフの作業時間を劇的に短縮し、業務効率を向上させることを目指す。
本バージョンでは、セキュアなユーザー管理機能を導入する。**管理者がアカウントを発行・管理**し、一般ユーザーは自身のSALON BOARD認証情報や利用サロン情報を安全に保存できる。これにより、セキュリティを確保しつつ、繰り返し利用する際の利便性を大幅に向上させる。

### **2. システムの目的とスコープ**

### **2.1. システム目的**

本アプリは、以下の機能を提供するセキュアなマルチユーザー対応Webアプリケーションである。

- 管理者によるユーザーアカウント管理機能（作成、編集、削除）。
- 発行されたアカウントでのみサインイン可能な、クローズドな認証システム。
- ユーザーごとにSALON BOARDの認証情報および対象サロン情報を暗号化して保存・管理する機能。
- スタイル情報ファイルと画像ファイルをWeb UIからアップロードし、自動投稿タスクを作成する機能。
- 作成されたタスクをバックグラウンドで非同期に実行する機能。
- タスクの進捗をリアルタイムで確認し、中断・再開する機能。

### **2.2. スコープ（対象範囲）**

**範囲内（In-Scope）:**

- **管理者**によるユーザーアカウントのCRUD（作成・読み取り・更新・削除）機能。
- 本アプリ専用アカウントによるサインイン・サインアウト機能。
- ユーザーごとのSALON BOARD認証情報・サロン情報のCRUD機能。
- スタイル情報ファイル（CSV/Excel）と画像ファイル（複数枚）のアップロード。
- 非同期でのバックグラウンドタスク（投稿処理）実行。
- タスクの実行状況の表示と管理（進捗確認、中断、再開）。
- スマートフォンでの利用を想定したレスポンシブUI。
- Dockerを用いたコンテナ化とVPS（Virtual Private Server）へのデプロイ。

**範囲外（Out-of-Scope）:**

- **一般ユーザーによるセルフサインアップ（新規アカウント登録）機能。**
- 複数人でのアカウント共有機能や、組織・階層構造を持つ権限管理機能。
- アプリ上でのスタイル情報ファイル（CSV/Excel）の編集機能。
- スタイル以外の情報（ブログ、クーポン等）の自動投稿機能。
- 外部サービス（メール、Slack等）への通知機能。

**将来拡張:**

- SALON BOARD上の投稿済みスタイルを削除する機能。

### **3. 利用者（アクター）とユースケース**

| アクター | 説明 | 主なユースケース |
| --- | --- | --- |
| **管理者**<br>(Admin) | 本アプリの全ユーザーを管理する特権を持つユーザー。 | 1. サインインする。<br>2. ユーザー管理画面で、一般ユーザーのアカウントを作成・編集（パスワードリセット等）・無効化/削除する。<br>3. （任意）全ユーザーのタスク実行状況を監視する。 |
| **一般ユーザー**<br>(Salon Staff) | 管理者からアカウントを付与されたサロンスタッフ。 | 1. 配布されたID/パスワードでサインインする。<br>2. 自身のSALON BOARD設定（ID/PW/サロン情報）を登録・更新する。<br>3. スタイル自動投稿タスクを作成・実行する。<br>4. 自身のタスクの進捗を確認する。<br>5. 自身のタスクを中断・再開する。 |

---

### **4. 機能要件**

### **4.1. ユーザーアカウント機能 (`FR-01`)**

- **FR-01-01 (ユーザーロール)**: システムには以下の2つのユーザーロールを定義する。
    - **管理者 (Admin)**: 全ユーザーの管理権限を持つ。
    - **一般ユーザー (User)**: 自身の情報管理とタスク実行のみ可能。
- **FR-01-02 (ユーザー作成)**: **管理者のみ**が、管理画面から新規ユーザーアカウントを作成できる。作成時には、ユーザーのメールアドレス（またはログインID）と初期パスワードを設定する。
- **FR-01-03 (ユーザー管理画面)**: 管理者向けに、以下の機能を持つ専用のユーザー管理画面を提供する。
    - ユーザー一覧の表示（ID, メールアドレス, ロール, ステータス）。
    - 新規ユーザー作成フォーム。
    - 既存ユーザーの編集機能（パスワードリセット、ロール変更）。
    - ユーザーアカウントの無効化（一時的な利用停止）/削除機能。
- **FR-01-04 (サインイン)**: 全てのユーザーは、配布されたIDとパスワードでサインインできる。
- **FR-01-05 (サインアウト)**: サインイン中のユーザーは、サインアウトできる。
- **FR-01-06 (パスワードハッシュ化)**: ユーザーのパスワードは、PBKDF2やbcryptなどの強力なハッシュ関数を用いてハッシュ化し、ソルトを付与してデータベースに保存する。
- **FR-01-07 (アクセス制御)**: 一般ユーザーは、自身が作成したSALON BOARD設定やタスク情報のみ閲覧・操作できる。管理者以外のユーザーがユーザー管理画面にアクセスすることはできない。
- **FR-01-08 (初回管理者アカウント作成)**: 最初の管理者アカウントは、**デプロイ後の初期設定として、サーバー上で実行するコマンドラインスクリプト**によって作成される。これにより、セキュアな初期セットアップを保証する。

### **4.2. SALON BOARD設定管理機能 (`FR-02`)**

- **FR-02-01 (情報登録・更新)**: 一般ユーザーは、サインイン後に自身のSALON BOARDの「ID」「パスワード」「対象サロンID/サロン名」を登録・更新できる設定画面を持つ。
- **FR-02-02 (情報暗号化)**: データベースに保存するSALON BOARDのパスワードは、AES-256などの強力な共通鍵暗号方式で**必ず暗号化**する。暗号化キーは環境変数として管理する。

### **4.3. タスク作成・実行機能 (`FR-03`)**

- **FR-03-01 (ファイルアップロード)**: ユーザーは、スタイル情報ファイル（CSV/Excel）と、それに対応する画像ファイルを複数枚アップロードできる。
- **FR-03-02 (設定選択)**: タスク実行時、ユーザーは保存済みのSALON BOARD設定をプルダウン等で選択する。
- **FR-03-03 (バリデーション)**: 「実行」ボタン押下時、ファイル間の整合性（画像ファイル名の存在確認など）を検証する。
- **FR-03-04 (非同期実行)**: 実行要求はバックグラウンドタスクとしてキューに追加され、ユーザーは結果を待たずに他の操作が可能となる。

### **4.4. 進捗確認・タスク管理機能 (`FR-04`)**

- **FR-04-01 (タスク一覧)**: ユーザーは、自身が実行依頼したタスクの一覧と、そのステータス（`待機中`, `実行中`, `完了`, `エラー`, `中断中`）を確認できる。
- **FR-04-02 (リアルタイム更新)**: WebSocketまたは定期的なAPIポーリングにより、進捗（例: `3 / 10 件完了`）を準リアルタイムで画面に反映する。
- **FR-04-03 (操作)**: ユーザーは、「実行中」のタスクを「中断」したり、「中断中」のタスクを「再開」したりできる。
- **FR-04-04 (結果確認)**: 「エラー」で終了したタスクについては、エラーログと失敗時のスクリーンショットをダウンロードできる。

---

### **5. 非機能要件**

### **5.1. ユーザビリティ**

- **UI-01**: 直感的でミニマルなUI。マニュアルを読まなくても操作が完結することを目指す。
- **UI-02**: レスポンシブデザインを徹底し、PCとスマートフォンの両方で最適な表示と操作性を提供する。

### **5.2. パフォーマンス**

- **PF-01**: UIの画面応答時間は3秒以内。
- **PF-02**: バックグラウンドタスクはWebサーバーとは別の独立したワーカープロセスで実行し、相互に影響を与えない。

### **5.3. セキュリティ**

- **SEC-01**: 通信はすべてTLS（HTTPS）で暗号化する。
- **SEC-02**: ユーザーパスワードは**ハッシュ化**、SALON BOARDパスワードは**暗号化**して保存する。
- **SEC-03**: 機密情報（DB接続情報, 暗号化キー, SECRET_KEY等）はすべて環境変数としてコンテナに渡し、コードリポジトリには含めない。
- **SEC-04**: XSS, CSRF対策など、標準的なWebセキュリティ対策を実装する。

### **5.4. デプロイと運用保守**

- **DEP-01 (コンテナ化)**: アプリケーション（Webサーバー、バックグラウンドワーカー）はDockerコンテナとして構築する。
- **DEP-02 (構成管理)**: `docker-compose.yml` を用いて、Web, ワーカー, データベース等の複数コンテナの構成と連携を定義する。
- **DEP-03 (デプロイ手順)**: VPSへのデプロイは、リポジトリをcloneし、環境変数ファイルを作成後、`docker-compose up -d` を実行するだけで完了するシンプルな手順とする。
- **DEP-04 (データ永続化)**: データベースのデータおよびログファイルは、DockerのVolume機能を用いてホストマシン上に永続化する。
- **DEP-05 (初回管理者作成)**: 初回デプロイ後、管理者が `docker-compose exec web python create_admin.py <email> <password>` のようなコマンドを実行することで、最初の管理者アカウントを作成できる仕組みを提供する。
- **MNT-01**: Playwrightのセレクタは外部設定ファイル（`selectors.yaml`）で管理し、軽微なサイト変更に迅速に対応できるようにする。
- **MNT-02**: アプリケーションログとタスクログをファイルに出力し、永続化する。

---

### **6. 画面設計の概要**

1. **公開ページ**:
    - **サインインページ**: メールアドレス、パスワード入力フォームのみ。新規登録リンクは存在しない。
2. **認証後ページ（要サインイン）**:
    - **ヘッダー**: ログイン中のユーザー名、設定ページへのリンク、サインアウトボタンを配置。
    - **ダッシュボード（タスク管理画面）**:
        - 「新規スタイル投稿」ボタン。
        - 自身が実行したタスクの一覧テーブル（ステータス、進捗、操作ボタン）。
    - **新規スタイル投稿ページ**:
        - 保存済みのSALON BOARD設定を選択するプルダウン。
        - ファイルアップロードUI（スタイル情報ファイル、画像ファイル）。
        - 「実行」ボタン。
    - **設定ページ**:
        - 自身のSALON BOARD設定を登録・更新するフォーム。
    - **管理者用ページ**（管理者ロールを持つユーザーにのみ表示）:
        - **ユーザー管理画面**: ユーザー一覧テーブル、新規ユーザー作成ボタン、各ユーザーの編集/削除ボタン。

---

### **7. システム構成案（Docker + VPS）**

- **Webサーバーコンテナ**: FastAPI + Uvicornを実行。APIエンドポイントとフロントエンド画面を提供。
- **ワーカーコンテナ**: Celeryなどのタスクキューワーカーを実行。Playwrightによる重い自動化処理を担当。
- **データベースコンテナ**: PostgreSQLなど。ユーザー情報、SALON BOARD設定、タスク情報を永続化。
- **キューコンテナ**: Redisなど。Webサーバーとワーカー間のタスクの受け渡しを行うブローカー。
- **リバースプロキシコンテナ（推奨）**: Nginxなど。HTTPS終端処理、静적ファイルの配信、Webサーバーへのリクエスト転送を担当。