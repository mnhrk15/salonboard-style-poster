{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>SALON BOARD 設定</h2>
        <button onclick="showCreateForm()" class="btn btn-primary">新規設定</button>
    </div>

    <div id="settings-list">
        <table class="table">
            <thead>
                <tr>
                    <th>設定名</th>
                    <th>SALON BOARD ログインID</th>
                    <th>サロンID</th>
                    <th>サロン名</th>
                    <th>作成日時</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="settings-tbody">
                <!-- Settings will be loaded here via JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for Create/Edit -->
<div id="setting-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 600px; margin: var(--spacing-md);">
        <div class="card-header">
            <h3 id="modal-title">新規設定</h3>
        </div>
        <form id="setting-form" onsubmit="handleSubmit(event)">
            <input type="hidden" id="setting_id" name="setting_id">

            <div class="form-group">
                <label for="setting_name" class="form-label required">設定名</label>
                <input type="text" id="setting_name" name="setting_name" class="form-input" required placeholder="例: 本店アカウント">
                <small class="form-text">この設定を識別するための名前（複数店舗がある場合など）</small>
            </div>

            <div class="form-group">
                <label for="sb_user_id" class="form-label required">SALON BOARD ログインID</label>
                <input type="text" id="sb_user_id" name="sb_user_id" class="form-input" required placeholder="SALON BOARDのログインIDを入力">
                <small class="form-text">SALON BOARDにログインする際のIDです</small>
            </div>

            <div class="form-group">
                <label for="sb_password" class="form-label required">SALON BOARD パスワード</label>
                <input type="password" id="sb_password" name="sb_password" class="form-input" required placeholder="SALON BOARDのパスワードを入力">
                <small class="form-text">パスワードは暗号化されて保存されます</small>
            </div>

            <div class="form-group">
                <label for="salon_id" class="form-label">サロンID（任意）</label>
                <input type="text" id="salon_id" name="salon_id" class="form-input" placeholder="複数店舗の場合のみ入力">
                <small class="form-text">複数店舗を管理している場合、対象サロンのIDを入力</small>
            </div>

            <div class="form-group">
                <label for="salon_name" class="form-label">サロン名（任意）</label>
                <input type="text" id="salon_name" name="salon_name" class="form-input" placeholder="複数店舗の場合のみ入力">
                <small class="form-text">複数店舗を管理している場合、対象サロンの名前を入力</small>
            </div>

            <div class="form-actions" style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">キャンセル</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentSettings = [];

async function loadSettings() {
    try {
        const response = await API.settings.list();
        currentSettings = response.data.settings;
        renderSettingsTable();
    } catch (error) {
        showFlash('設定の読み込みに失敗しました: ' + error.message, 'error');
    }
}

function renderSettingsTable() {
    const tbody = document.getElementById('settings-tbody');
    if (!tbody) return;

    if (currentSettings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: var(--spacing-xl); color: var(--text-secondary);">設定がありません。「新規設定」から作成してください。</td></tr>';
        return;
    }

    tbody.innerHTML = currentSettings.map(setting => `
        <tr>
            <td>${setting.setting_name || '-'}</td>
            <td>${setting.sb_user_id || '-'}</td>
            <td>${setting.salon_id || '-'}</td>
            <td>${setting.salon_name || '-'}</td>
            <td>${formatDate(setting.created_at)}</td>
            <td>
                <button onclick="editSetting('${setting.id}')" class="btn btn-secondary btn-sm">編集</button>
                <button onclick="deleteSetting('${setting.id}')" class="btn btn-danger btn-sm">削除</button>
            </td>
        </tr>
    `).join('');
}

function showCreateForm() {
    document.getElementById('modal-title').textContent = '新規設定';
    document.getElementById('setting-form').reset();
    document.getElementById('setting_id').value = '';
    document.getElementById('sb_password').placeholder = 'SALON BOARDのパスワードを入力';
    document.getElementById('sb_password').required = true;
    document.getElementById('setting-modal').style.display = 'flex';
}

async function editSetting(settingId) {
    try {
        const response = await API.settings.get(settingId);
        const setting = response.data || response;

        document.getElementById('modal-title').textContent = '設定編集';
        document.getElementById('setting_id').value = setting.id;
        document.getElementById('setting_name').value = setting.setting_name || '';
        document.getElementById('sb_user_id').value = setting.sb_user_id || '';
        document.getElementById('sb_password').value = '';
        document.getElementById('sb_password').placeholder = '変更する場合のみ入力';
        document.getElementById('sb_password').required = false;
        document.getElementById('salon_id').value = setting.salon_id || '';
        document.getElementById('salon_name').value = setting.salon_name || '';
        document.getElementById('setting-modal').style.display = 'flex';
    } catch (error) {
        showFlash('設定の読み込みに失敗しました: ' + error.message, 'error');
    }
}

async function deleteSetting(settingId) {
    if (!confirm('この設定を削除しますか？')) return;

    try {
        await API.settings.delete(settingId);
        showFlash('設定を削除しました', 'success');
        await loadSettings();
    } catch (error) {
        showFlash('削除に失敗しました: ' + error.message, 'error');
    }
}

function closeModal() {
    document.getElementById('setting-modal').style.display = 'none';
    document.getElementById('setting-form').reset();
}

async function handleSubmit(event) {
    event.preventDefault();

    const form = event.target;
    const button = form.querySelector('button[type="submit"]');
    const settingId = form.setting_id.value;

    const data = {
        setting_name: form.setting_name.value,
        sb_user_id: form.sb_user_id.value,
        sb_password: form.sb_password.value,
        salon_id: form.salon_id.value || null,
        salon_name: form.salon_name.value || null
    };

    setButtonLoading(button, true);

    try {
        if (settingId) {
            // Update
            if (!data.sb_password) {
                delete data.sb_password;
            }
            await API.settings.update(settingId, data);
            showFlash('設定を更新しました', 'success');
        } else {
            // Create
            await API.settings.create(data);
            showFlash('設定を作成しました', 'success');
        }

        closeModal();
        await loadSettings();
    } catch (error) {
        showFlash('保存に失敗しました: ' + error.message, 'error');
        setButtonLoading(button, false);
    }
}

// Close modal when clicking outside
document.getElementById('setting-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'setting-modal') {
        closeModal();
    }
});

// Initialize page when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    requireAuth();
    loadSettings();
});
</script>
{% endblock %}
